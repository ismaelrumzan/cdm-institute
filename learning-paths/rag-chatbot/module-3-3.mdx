---
title: "3.3 Update Server Action"
description: "Integrate embedding generation into the resource creation workflow."
---

import { AIPromptReflection } from "/snippets/ai-prompt-reflection.jsx";

## Current Server Action

Open the file at `lib/actions/resources.ts`. This file has one function, `createResource`, which, as the name implies, allows you to create a resource.

```typescript lib/actions/resources.ts
"use server";

import {
  NewResourceParams,
  insertResourceSchema,
  resources,
} from "@/lib/db/schema/resources";
import { db } from "../db";

export const createResource = async (input: NewResourceParams) => {
  try {
    const { content } = insertResourceSchema.parse(input);

    const [resource] = await db
      .insert(resources)
      .values({ content })
      .returning();

    return "Resource successfully created.";
  } catch (e) {
    if (e instanceof Error)
      return e.message.length > 0 ? e.message : "Error, please try again.";
  }
};
```

This function is a [Server Action](https://nextjs.org/docs/app/guides/backend-for-frontend#server-actions), as denoted by the `"use server";` directive at the top of the file. This means that it can be called anywhere in your Next.js application. This function will take an input, run it through a Zod schema to ensure it adheres to the correct schema, and then creates a new resource in the database. This is the ideal location to generate and store embeddings of the newly created resources.

<AIPromptReflection
  question="What is a Zod schema? How does it work? How does `insertResourceSchema` check if the input is valid?"
  chatgptButtonText="Ask ChatGPT"
  claudeButtonText="Ask Claude"
/>

---

## Updated Server Action

Update the file with the following code:

```typescript lib/actions/resources.ts lines highlight={9-10,21-27}
"use server";

import {
  NewResourceParams,
  insertResourceSchema,
  resources,
} from "@/lib/db/schema/resources";
import { db } from "../db";
import { generateEmbeddings } from "../ai/embedding";
import { embeddings as embeddingsTable } from "../db/schema/embeddings";

export const createResource = async (input: NewResourceParams) => {
  try {
    const { content } = insertResourceSchema.parse(input);

    const [resource] = await db
      .insert(resources)
      .values({ content })
      .returning();

    const embeddings = await generateEmbeddings(content);
    await db.insert(embeddingsTable).values(
      embeddings.map((embedding) => ({
        resourceId: resource.id,
        ...embedding,
      }))
    );

    return "Resource successfully created and embedded.";
  } catch (error) {
    return error instanceof Error && error.message.length > 0
      ? error.message
      : "Error, please try again.";
  }
};
```

---

## Understanding the Changes

First, you call the `generateEmbeddings` function created in the previous step, passing in the source material (`content`). Once you have your embeddings of the source material, you can save them to the database, passing the `resourceId` alongside each embedding.

### Key Changes Made

<Columns cols={2}>
  <Card title="Import Statements" icon="import">
    - Added import for generateEmbeddings function - Added import for embeddings
    table schema
  </Card>
  <Card title="Embedding Generation" icon="zap">
    - Call generateEmbeddings with content - Process the returned embeddings
    array
  </Card>
</Columns>
<Columns cols={2}>
  <Card title="Database Storage" icon="database">
    - Insert embeddings into embeddings table - Map each embedding with
    resourceId
  </Card>
  <Card title="Success Message" icon="check">
    - Updated return message to indicate embedding creation - Enhanced error
    handling
  </Card>
</Columns>

---

## Test the Implementation

Let's create a simple test to verify that your embedding generation is working correctly.

### Create a Test Function

Add the following test function to your `lib/ai/embedding.ts` file:

```typescript
// Test function - you can remove this after testing
export const testEmbeddingGeneration = async () => {
  const testContent =
    "This is a test document. It contains multiple sentences. Each sentence will become a chunk. The chunks will be converted to embeddings.";

  try {
    console.log("Testing embedding generation...");
    const result = await generateEmbeddings(testContent);

    console.log("âœ… Embedding generation successful!");
    console.log(`ğŸ“Š Generated ${result.length} embeddings`);
    console.log(`ğŸ“ First chunk: "${result[0]?.content}"`);
    console.log(
      `ğŸ”¢ First embedding dimensions: ${result[0]?.embedding.length}`
    );

    return result;
  } catch (error) {
    console.error("âŒ Embedding generation failed:", error);
    throw error;
  }
};
```

### Run the Test

To test the embedding generation function, we'll create a dedicated test file and run it using a script.

<Steps>
  <Step title="Create the Test File">
    Create a new file at `/tests/test-embeddings.js`:

    ```javascript
    import "dotenv/config";
    import { testEmbeddingGeneration } from "../lib/ai/embedding";

    testEmbeddingGeneration()
      .then((result) => console.log("Test completed successfully"))
      .catch((error) => console.error("Test failed:", error));
    ```

  </Step>

  <Step title="Add Test Script to package.json">
    Add this line to the scripts section of your `package.json`:

    ```json
    {
      "scripts": {
        "test:embeddings": "npx tsx tests/test-embeddings.js"
      }
    }
    ```

  </Step>

  <Step title="Update Dependencies">
    Make sure you have the required dependencies. You may need to update or add:

    ```json
    {
      "dependencies": {
        "zod": "^4.1.3"
      }
    }
    ```

  </Step>

  <Step title="Run the Test">
    Execute the following command in your terminal:

    ```bash
    pnpm run test:embeddings
    ```

  </Step>

  <Step title="Check for Errors">
    If the test fails, check the error messages in the terminal output. Common issues include:

    - Missing environment variables
    - Incorrect API keys
    - Network connectivity problems
    - Missing dependencies

  </Step>
</Steps>

### Expected Output

If everything is working correctly, you should see output similar to:

```
Testing embedding generation...
âœ… Embedding generation successful!
ğŸ“Š Generated 4 embeddings
ğŸ“ First chunk: "This is a test document"
ğŸ”¢ First embedding dimensions: 1536
Test completed successfully
```

### What to Check

<Columns cols={2}>
  <Card title="Function Execution" icon="play">
    - No errors during execution - Console logs appear as expected - Function
    returns an array of embeddings
  </Card>
  <Card title="Output Format" icon="check">
    - Each embedding has content and embedding properties - Embedding arrays
    have 1536 dimensions - Content matches the input chunks
  </Card>
</Columns>

<Warning>
  **Remember**: This test function is for development purposes only. Remove it
  from your production code after testing.
</Warning>

<AIPromptReflection
  question="What could cause the embedding generation to fail? What are common issues when testing AI SDK integration? How would you debug if the test doesn't work as expected?"
  chatgptButtonText="Ask ChatGPT"
  claudeButtonText="Ask Claude"
/>
